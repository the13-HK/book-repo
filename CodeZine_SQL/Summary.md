### 3 値論理と NULL

- 3 値論理とは、真(true)、偽(false)、不明(unknown)の 3 つの値を持つ論理。
- NULL には、値が不明であること（未知）を表す意味と、値が存在しないこと（適用不能）を表す意味の 2 つがある。
- NULL との比較演算は、常に不明(UNKNOWN)になるため、NULL の判定は、IS NULL または IS NOT NULL を使用する。
- 真偽値における unknown と NULL の一種の UNKNOWN とは異なる。
  - unknown と unknown の比較は TRUE になるが、UNKNOWN と UNKNOWN の比較は unknown になる。
    - unknown は状態を表すものであり、True、False と同レベルのもの。
- 排中律（排中律）：ある命題が真であるか偽であるかのいずれかであること。
  - 3 値論理では、排中律が成り立たない。
  - 3 値論理では、真でも偽でもない不明な状態が存在するため、排中律が成り立たない。
- CASE 式において、WHEN 句 に NULL を指定しても、NULL との比較は不明になるため、THEN で指定した値はセットされず、ELSE 句 が実行される。
  - ELSE 句 がない場合は、NULL が返される。
- NOT IN と NOT EXISTS は NULL を含む場合に注意が必要。
  - NOT IN は、NULL を含む場合、NULL との比較は不明になるため、NULL が返される。
  - NOT EXISTS は、NULL を含む場合、NULL との比較は不明になるため、NULL が返されるが、NULL は偽として扱われるため、NOT EXISTS は常に真になる。
- Null を防ぐためには
  - テーブル定義に NOT NULL 制約を付与する。
- Oracle の NULL と 空文字 に関するローカルルール
  - 原則として、NULL と空文字は同じものとして扱う。
  - 文字連結の時だけは NULL を空文字として扱う。
  - 文字連結で両方 NULL の場合は NULL を返す。
    `「Oracle は、 長 さが 0（ ゼロ） の 文字列 を NULL として 処理 し ます が、 長 さが 0（ ゼロ） の 文字列 を 別 の オペランド と 連結 する と、 その 結果 は 常に もう 一方 の オペランド になり ます。 結果 が NULL に なる のは、 2 つ の NULL 文字列 を 連結 し た とき のみ です。 ただし、 この 処理 は Oracle Database の 今後 の バージョン でも 継続 さ れる とは かぎり ませ ん。」

ミック. 達人に学ぶ SQL 徹底指南書 第 2 版 初級者で終わりたくないあなたへ (p.144). 株式会社翔泳社. Kindle 版. `

- NULL を扱うための特別な関数
  - COALESCE: NULLw を指定した値に置き換える。
  - NULLIF: 特定の条件に合致した場合に NULL を返す。cd

### EXISTS 述語 の 使い方

- SQL の基礎理論は以下二つからなる
  - 集合論
    - ベン図とかを使って、データの集まりの関係を表す。
  - 述語論理
    - 述語は戻り値が真か偽かを返す関数のようなもの。
    - 比較述語
    - IN 述語
    - **EXISTS 述語**
      - サブクエリの結果が 1 件以上存在する場合に真を返す。
      - サブクエリを使うことで複数行のデータを一単位として扱うことができ、パフォーマンスも優れている。
      - 集合そのものを入力する、二階述語。
    - 限定述語
    - LIKE 述語
    - BETWEEN 述語
    - IS NULL 述語
- EXISTS は量化という述語論理の機能を実現する。
  - 量化とは、ある条件を満たすデータが存在するかどうかを判定すること。
  - 量化は、全称量化と存在量化の 2 つがある。
    - 全称量化: ある条件を満たすデータが全て存在するかどうかを判定する。
    - 存在量化: ある条件を満たすデータが 1 つでも存在するかどうかを判定する。
  - EXISTS は存在量化を実現する。
  - 全称量化に対応する述語はないが、NOT EXISTS を使うことで全称量化を実現することができる。

### HAVING 句の力

- Having 句は、集計関数を使った結果に対して条件を指定するための句。
  - where との違い
    - 実行順序にルールがあり、where → groupby → HAVING の順序で実行される。
    - where 句は group by の前に実行されるため、集計関数を使った条件指定では使えない。
- 利用パターン
  - データの欠番を探す
    - 検索対象の列とテーブルの sequence を結合して、欠番を探す。
  - 最頻値(mode)を求める
- バスケット解析とは、「頻繁に一緒に買われる商品」の法則性を見つけるもの

### ウィンドウ関数で行間比較を行う

- ウィンドウ関数は相関サブクエリの代替として使える。
  - 相関サブクエリは、サブクエリの結果を使ってメインクエリの結果を制御するためのもの。
    - サブクエリはメインクエリとは別のクエリを実行するため、パフォーマンスが悪い。
    - 可読性もよくない

### 外部結合の使い方

- SQL は本来データ検索言語であるが、レポート作成やデータの集計など、データの加工処理機能を求められることが多い。
  - 外部結合はデータフォーマッティングに使われることが多い。

### SQL で 集合 演算

- 集合演算は入力に「集合」をとる演算である。
  - SQL では、テーブルやビューを入力にとる演算を行うことができる。
- SQL における集合は重複を許すものと重複を許さないものの 2 種類がある。
  - 重複を許す場合は ALL を指定する。
    - ALL をつけると重複削除のための暗黙のソートが行われないためパフォーマンスが向上する。
    - 重複を気にしなくてよい場合、もしくは確実に重複がない場合に ALL を指定すると良い。
  - 重複を許さない場合は DISTINCT を指定する。
  - UNIPN や INTERSECT などの演算子は重複を許さない集合を入力にとる。
- 集合演算子ごとに実行順序が異なる。
  - UNION と EXCEPT に対して INTERSECT は優先順位が高い。
- 除算の標準的な定義がない。
  - 和は UNION、積は INTERSECT、差は EXCEPT となる。
- A と B の集合が一致しているかどうかを判別する方法
  - ( A UNION B ) EXCEPT ( A INTERSECT B )の結果が空集合であるかどうかを判別する。→ 相当性
    - 列名や列数は一切知る必要はない。
    - 相違した行を抽出するためには、( A EXCEPT B ) UNION ALL ( B EXCEPT A ) とする。

#### UNION の特徴

- 冪等性がある
  - 二幸演算子の任意の入力 S について S\*S=S が成り立つ
  - 繰り返し処理を実行しても結果が変わらない

#### INTERSECT の特徴

- 冪等性がある
  - 二幸演算子の任意の入力 S について S\*S=S が成り立つ
  - 繰り返し処理を実行しても結果が変わらない

### SQL で数列を扱う

- 関係モデルにおけるデータ構造は本来順序という概念はない。

  - 述語論理の量化子や順序数を定義する再帰集合を応用することで、数列を扱うことができる。
  - 基本的な SQL は順序を無視した集合とみなす。
  - 順序を持った集合を扱う際はウィンドウ関数を使うことが多い。

  ### SQL を早くするためのテクニック

  - 効率の良い検索を利用する
    - サブクエリを引数にとる場合、IN より EXISTS を使う
      - IN 句は可読性は高いが、パフォーマンスが悪い。
        - 結合キーに対してインデックスを張っている場合は EXISTS は Class_B テーブルの実表は見に行かず、インデックスを参照するのみのため。
        - EXISTS は一行でも条件に合致する行を見つけたら、それ以上の行を見に行かないため。
    - サブクエリを引数にとる場合、IN より結合を使う
  - ソートを回避する
    - 暗黙的にソートが行われていることがあるため、意識してソートされない処理を実装する。
      - GROUP BY
      - ORDER BY
      - 集約関数
      - DISTINCT
      - 集合演算子
      - ウインドウ関数
  - 集合演算子の ALL オプションを使用することで不要なソートを回避する
  - DISTINCT を EXISTS に置き換える
  - 極値関数でインデックスを使う
  - GROUP BY と HAVING でインデックスを使用する
  - WHERE 句出かける条件は HAVING 句には書かない
  - インデックスが使用されるような SQL を書く
    - 列は裸になるように SQL を書く
    - NULL が含まれないように SQL を書く
    - 否定形がないように SQL を書く
    - OR を使わないように SQL を書く
    - 複合策引の際列の順番を考慮する
    - LIKE 句のパターンを最小限にする
    - 暗黙の型変換を避ける

### SQL プログラミング作法

- アプリケーション保守やマイグレーションといった既存資産の存在を前提としたプロジェクトが増えてきたため、「読みやすく保守しやすいコード」の重要性は増している。
  - プログラミング言語は人間が読み書きできる言語であるべき、という認識が高まる
  - SQL は他の手続き型言語とは特徴が異なるため、蓄積されてきたものが少ない。
  - 必要性もそこまでなかったが、近年んおデータ分析の需要増加により、SQL のプログラミング作法についての議論が活発になってきた。

#### 命名規則を守る

- SQL におけるテーブルやカラムの名前を有機的なものにする
  - 使用する文字は書き三種類
    - アルファベット
    - 数字
    - アンダースコア
- 英単語を使うのかローマ字表記を使うのか問題
  - 一長一短ある
  - 日本人だけのプロジェクトだと見慣れない英語を使用するとかえって可読性が下がる。
- 1 つの列に対して複数の意味を持たせるのはご法度

#### コーディングの指針

- コメントはできるだけかく。
  - 中にはコメントがなくてもわかるような SQL を書くことを求める人もいる。
  - SQL は宣言型言語かつ、段階的な実行デバックが難しいため、コメントで段階的な処理の説明を追加させる行為は必要。
- インテンド、スペースを使用することで可読性を上げる。
- 大文字小文字を使い分ける
  - SQL は大文字小文字を区別しないが、可読性を上げるために大文字小文字を使い分ける。
  - 予約語 は 大文字、 列 名 や テーブル 名 は 小文字を使うのでデファクト
- カンマは要素と要素の中間に置く
- ワイルドカードは使用しない。
- ORDER BY で列番号は使用しない。
- 出来るだけ標準語を使用する。
- 外部結合の左派閥と右派閥どっちを使用するか
  - 左結合を使用することで、（左にマスターテーブルを持ってくる前提で）SQL と結果イメージが一致するため可読性が上がるというメリットがある。
- 相関サブクエリは極力使用しない。
- SQL を作成するとき、FROM 句から書くとよい。（SQL の実行順序に倣って書くとよい。）
  - SQL の実行順序は、FROM → WHERE → GROUP BY → HAVING → SELECT → ORDER BY

### なぜ"関係"モデルという名前なのか

理由は二つ

- 複数の対象の間の関係はつなぎデータ構造で表現されなければならないと考える傾向にあった。
- 関係よりも表の方が抽象水準が低いため。

#### 関係の定義

- 表との違い
  - 表は順序を持たないが、関係は順序を持つ。
  - 表は重複を許すが、関係は重複を許さない。
  - 表の関係は左から右へ順序があるが、関係は順序がない。
  - 関係の属性値は分割できないが、表の属性値は分割できる。
    関係よりも票の方が定義の緩やかであいまいな概念である。
    関係は各データ群の直積をとるような関係のことを表す。
    DBMS
    MS はデータの定義域を定義することはできるが比較的まだ未解決の問題が多い。

#### 再帰的な関係

DBMS における関係は現状再帰的な関係の定義が出来ない。
DBMS は 1 階の関係しか管理できない。いうなれば、深さ 1 のディレクトリしか定義できないファイルシステム
